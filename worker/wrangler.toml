# ⚠️  DEPRECATED — Use wrangler.prod.toml or wrangler.staging.toml instead
#
# This legacy config deploys to api-relay.divine.video with the old D1 database
# (blossom-webhook-events). New deployments should use:
#   - Production: npx wrangler deploy --config wrangler.prod.toml
#   - Staging:    npx wrangler deploy --config wrangler.staging.toml
#
# ABOUTME: Cloudflare Worker for Divine Relay Admin API (LEGACY)
# ABOUTME: Handles NIP-86 signing and publishing

name = "divine-relay-admin-api"
main = "src/index.ts"
compatibility_date = "2024-12-01"

# Custom domain routes
routes = [
  { pattern = "relay.admin.divine.video/api/*", zone_name = "divine.video" },
  { pattern = "api-relay.divine.video/*", zone_name = "divine.video" }
]

# The NOSTR_NSEC secret must be set via: wrangler secret put NOSTR_NSEC

# CF Access credentials - set via: wrangler secret put CF_ACCESS_CLIENT_ID / CF_ACCESS_CLIENT_SECRET

[vars]
RELAY_URL = "wss://relay.divine.video"
AUTO_HIDE_ENABLED = "false"
TRUSTED_CLIENTS = "diVine,divine-web,divine-mobile"
# Path for NIP-86 management API (appended to relay URL converted to HTTPS)
MANAGEMENT_PATH = "/"
# URL for media moderation service
MODERATION_SERVICE_URL = "https://moderation.admin.divine.video"
# Allow both the main frontend and Cloudflare Pages preview deployments
ALLOWED_ORIGINS = "https://relay.admin.divine.video,*.divine-relay-manager.pages.dev,*.divine-relay-admin.pages.dev"
# Zendesk custom field IDs for webhook callback
ZENDESK_FIELD_ACTION_STATUS = "14545793289743"
ZENDESK_FIELD_ACTION_REQUESTED = "14545826900367"

# D1 Database for moderation decision log
[[d1_databases]]
binding = "DB"
database_name = "blossom-webhook-events"
database_id = "829f06cf-294b-4491-8611-30fc53df2589"

# Service binding to divine-realness worker (bypasses CF Access 522 issue)
[[services]]
binding = "REALNESS"
service = "divine-ai-detector"

# Durable Objects for persistent state (needed for local dev)
[durable_objects]
bindings = [
  { name = "REPORT_WATCHER", class_name = "ReportWatcher" }
]

[[migrations]]
tag = "v1"
new_classes = ["ReportWatcher"]
